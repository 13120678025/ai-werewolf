<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸº æ¸¸æˆè¿›è¡Œä¸­ - AIç‹¼äººæ€</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #00f0ff;
      --wolf: #ff4757;
      --good: #2ed573;
      --gold: #ffd700;
      --bg-dark: #0a0a0f;
      --bg-panel: rgba(20, 20, 30, 0.9);
      --border-glow: rgba(0, 240, 255, 0.3);
    }
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-dark);
      min-height: 100vh;
      color: #fff;
      overflow-x: hidden;
      transition: background 0.5s ease;
    }
    
    body.night-mode {
      background: linear-gradient(180deg, #0a0a0f 0%, #1a0a0f 100%);
    }
    
    body.day-mode {
      background: linear-gradient(180deg, #0a0a0f 0%, #1a1a2e 100%);
    }
    
    /* ä¸»å¸ƒå±€ */
    .game-container {
      display: grid;
      grid-template-columns: 280px 1fr 300px;
      gap: 20px;
      max-width: 1800px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
    }
    
    /* é¡¶éƒ¨çŠ¶æ€æ  */
    .top-bar {
      grid-column: 1 / -1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      background: var(--bg-panel);
      border-radius: 16px;
      border: 1px solid var(--border-glow);
    }
    
    .game-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.3rem;
      color: var(--primary);
    }
    
    .game-info {
      display: flex;
      align-items: center;
      gap: 30px;
    }
    
    .day-indicator {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      padding: 8px 20px;
      border-radius: 25px;
      font-weight: 700;
    }
    
    .day-indicator.night {
      background: rgba(255, 71, 87, 0.2);
      color: var(--wolf);
      box-shadow: 0 0 20px rgba(255, 71, 87, 0.3);
    }
    
    .day-indicator.day {
      background: rgba(255, 215, 0, 0.2);
      color: var(--gold);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    .phase-indicator {
      font-size: 1.1rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .alive-count {
      display: flex;
      gap: 15px;
    }
    
    .count-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 600;
    }
    
    .count-wolf {
      background: rgba(255, 71, 87, 0.2);
      color: var(--wolf);
    }
    
    .count-good {
      background: rgba(46, 213, 115, 0.2);
      color: var(--good);
    }
    
    .controls {
      display: flex;
      gap: 10px;
    }
    
    /* ç©å®¶åˆ—è¡¨ï¼ˆå·¦ä¾§ï¼‰ */
    .players-panel {
      background: var(--bg-panel);
      border-radius: 16px;
      border: 1px solid var(--border-glow);
      padding: 20px;
      overflow-y: auto;
      max-height: calc(100vh - 100px);
    }
    
    .panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
      color: var(--primary);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .player-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .player-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .player-card:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .player-card.current-speaker {
      border-color: var(--gold);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }
    
    .player-card.dead {
      opacity: 0.5;
      filter: grayscale(1);
    }
    
    .player-card.dead::after {
      content: 'â˜ ï¸';
      position: absolute;
      right: 10px;
      font-size: 1.2rem;
    }
    
    .player-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      position: relative;
    }
    
    .player-avatar.wolf { border-color: var(--wolf); }
    .player-avatar.seer { border-color: var(--primary); }
    .player-avatar.witch { border-color: #a55eea; }
    .player-avatar.hunter { border-color: var(--gold); }
    .player-avatar.villager { border-color: var(--good); }
    
    .player-info {
      flex: 1;
    }
    
    .player-name {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .player-role {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .player-badge {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .badge-ai {
      background: rgba(0, 240, 255, 0.2);
      color: var(--primary);
    }
    
    .badge-human {
      background: rgba(46, 213, 115, 0.2);
      color: var(--good);
    }
    
    .player-status {
      font-size: 0.8rem;
      color: var(--good);
    }
    
    .player-status.dead {
      color: var(--wolf);
    }
    
    /* å¯¹è¯åŒºåŸŸï¼ˆä¸­é—´ï¼‰ */
    .chat-panel {
      background: var(--bg-panel);
      border-radius: 16px;
      border: 1px solid var(--border-glow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chat-header {
      padding: 15px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.1rem;
      color: var(--primary);
    }
    
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .message {
      display: flex;
      gap: 12px;
      animation: messageIn 0.3s ease;
    }
    
    @keyframes messageIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message.system {
      justify-content: center;
    }
    
    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    
    .message-content {
      flex: 1;
      max-width: 80%;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    
    .message-name {
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    .message-role {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .message-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      border-top-left-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      line-height: 1.6;
      font-size: 0.95rem;
    }
    
    .message.system .message-bubble {
      background: rgba(255, 215, 0, 0.1);
      color: var(--gold);
      text-align: center;
      border-radius: 20px;
    }
    
    .message.system.death .message-bubble {
      background: rgba(255, 71, 87, 0.15);
      color: var(--wolf);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }
    
    .message.system.vote-start .message-bubble {
      background: rgba(0, 240, 255, 0.15);
      color: var(--primary);
      border: 1px solid rgba(0, 240, 255, 0.3);
      font-weight: 600;
    }
    
    .message.system.vote-detail .message-bubble {
      background: rgba(0, 240, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
      font-size: 0.9rem;
      padding: 10px 14px;
    }
    
    .message.system.vote-result .message-bubble {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.2), rgba(255, 215, 0, 0.1));
      color: var(--gold);
      border: 1px solid rgba(255, 71, 87, 0.3);
      font-weight: 600;
    }
    
    .message.system.hunter .message-bubble {
      background: rgba(255, 165, 2, 0.15);
      color: var(--gold);
      border: 1px solid rgba(255, 165, 2, 0.3);
    }
    
    .message-time {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 5px;
    }
    
    /* ä¿¡æ¯é¢æ¿ï¼ˆå³ä¾§ï¼‰ */
    .info-panel {
      background: var(--bg-panel);
      border-radius: 16px;
      border: 1px solid var(--border-glow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
      max-height: calc(100vh - 100px);
    }
    
    .info-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 15px;
    }
    
    .section-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .phase-timeline {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .phase-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 0.85rem;
    }
    
    .phase-item.active {
      background: rgba(0, 240, 255, 0.1);
      border: 1px solid var(--primary);
    }
    
    .phase-item.completed {
      opacity: 0.5;
    }
    
    .phase-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }
    
    /* æŠ•ç¥¨åŒºåŸŸ */
    .vote-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 15px;
    }
    
    .vote-progress {
      margin-top: 10px;
    }
    
    .vote-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .vote-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--gold));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .vote-targets {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .vote-target {
      padding: 5px 12px;
      background: rgba(255, 71, 87, 0.2);
      color: var(--wolf);
      border-radius: 15px;
      font-size: 0.8rem;
    }
    
    /* æ“ä½œæŒ‰é’® */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .btn {
      font-family: 'Rajdhani', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #0099cc 100%);
      color: #000;
    }
    
    .btn-primary:hover {
      box-shadow: 0 4px 15px rgba(0, 240, 255, 0.4);
      transform: translateY(-2px);
    }
    
    .btn-gold {
      background: linear-gradient(135deg, var(--gold) 0%, #ffaa00 100%);
      color: #000;
    }
    
    .btn-gold:hover {
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    }
    
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    
    .btn-secondary:hover {
      background: rgba(0, 240, 255, 0.1);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* èƒœåˆ©å¼¹çª— */
    .winner-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.5s ease;
    }
    
    .winner-modal.active {
      display: flex;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .winner-content {
      text-align: center;
      animation: winnerPop 0.5s ease;
    }
    
    @keyframes winnerPop {
      0% {
        opacity: 0;
        transform: scale(0.5);
      }
      50% {
        transform: scale(1.1);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .winner-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 4rem;
      font-weight: 900;
      margin-bottom: 30px;
      text-shadow: 0 0 50px currentColor;
    }
    
    .winner-title.wolf { color: var(--wolf); }
    .winner-title.village { color: var(--good); }
    
    .winner-text {
      font-size: 1.5rem;
      margin-bottom: 40px;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .winner-stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 40px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 2rem;
      color: var(--primary);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.6);
    }
    
    /* å“åº”å¼ */
    @media (max-width: 1200px) {
      .game-container {
        grid-template-columns: 1fr;
        padding: 15px;
      }
      
      .players-panel,
      .info-panel {
        max-height: none;
      }
      
      .chat-panel {
        order: -1;
        min-height: 400px;
      }
    }
    
    /* æ»šåŠ¨æ¡ */
    ::-webkit-scrollbar {
      width: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--primary);
      border-radius: 3px;
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* å€’è®¡æ—¶ */
    .countdown {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      color: var(--gold);
      animation: countdownPulse 1s infinite;
    }
    
    @keyframes countdownPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="top-bar">
      <div class="game-title">ğŸº AIç‹¼äººæ€ Â· <span id="gameId">LOADING...</span></div>
      
      <div class="game-info">
        <div class="day-indicator night" id="dayIndicator">
          ç¬¬ <span id="dayNum">0</span> å¤©
        </div>
        <div class="phase-indicator" id="phaseIndicator">ç­‰å¾…å¼€å§‹</div>
        
        <div class="alive-count">
          <div class="count-item count-wolf">
            <span>ğŸº</span> <span id="wolfCount">3</span> ç‹¼
          </div>
          <div class="count-item count-good">
            <span>ğŸ‘¥</span> <span id="goodCount">7</span> å¥½äºº
          </div>
        </div>
      </div>
      
      <div class="controls">
        <button class="btn btn-secondary" id="nextBtn" onclick="nextPhase()">
          â­ï¸ ä¸‹ä¸€æ­¥
        </button>
        <button class="btn btn-primary" id="autoBtn" onclick="autoPlay()">
          âš¡ è‡ªåŠ¨
        </button>
      </div>
    </div>
    
    <!-- ç©å®¶åˆ—è¡¨ -->
    <div class="players-panel">
      <h3 class="panel-title">ğŸ‘¥ ç©å®¶åˆ—è¡¨</h3>
      <div class="player-list" id="playerList">
        <!-- ç©å®¶å¡ç‰‡å°†é€šè¿‡JSæ¸²æŸ“ -->
      </div>
    </div>
    
    <!-- å¯¹è¯åŒºåŸŸ -->
    <div class="chat-panel">
      <div class="chat-header">
        <span class="chat-title">ğŸ’¬ å¯¹è¯è®°å½•</span>
        <span id="speakerInfo"></span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <div class="message system">
          <div class="message-content">
            <div class="message-bubble">ğŸ® æ¸¸æˆå³å°†å¼€å§‹ï¼Œè¯·ç­‰å¾…...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ä¿¡æ¯é¢æ¿ -->
    <div class="info-panel">
      <div class="info-section">
        <div class="section-title">ğŸ“‹ æ¸¸æˆé˜¶æ®µ</div>
        <div class="phase-timeline" id="phaseTimeline">
          <div class="phase-item active" data-phase="waiting">
            <div class="phase-icon">â³</div>
            <span>ç­‰å¾…å¼€å§‹</span>
          </div>
          <div class="phase-item" data-phase="night_wolf">
            <div class="phase-icon">ğŸº</div>
            <span>ç‹¼äººè¡ŒåŠ¨</span>
          </div>
          <div class="phase-item" data-phase="night_seer">
            <div class="phase-icon">ğŸ”®</div>
            <span>é¢„è¨€å®¶æŸ¥éªŒ</span>
          </div>
          <div class="phase-item" data-phase="night_witch">
            <div class="phase-icon">ğŸ§ª</div>
            <span>å¥³å·«è¡ŒåŠ¨</span>
          </div>
          <div class="phase-item" data-phase="dawn">
            <div class="phase-icon">ğŸŒ…</div>
            <span>å¤©äº®å…¬å‘Š</span>
          </div>
          <div class="phase-item" data-phase="day_speech">
            <div class="phase-icon">ğŸ—£ï¸</div>
            <span>ç™½å¤©å‘è¨€</span>
          </div>
          <div class="phase-item" data-phase="vote">
            <div class="phase-icon">ğŸ—³ï¸</div>
            <span>æŠ•ç¥¨æ”¾é€</span>
          </div>
        </div>
      </div>
      
      <div class="vote-section" id="voteSection" style="display: none;">
        <div class="section-title">ğŸ—³ï¸ æŠ•ç¥¨ç»“æœ</div>
        <div class="vote-progress">
          <div class="vote-bar">
            <div class="vote-fill" id="voteFill" style="width: 0%"></div>
          </div>
          <div class="vote-targets" id="voteTargets"></div>
        </div>
      </div>
      
      <div class="info-section">
        <div class="section-title">ğŸ“– æ¸¸æˆè§„åˆ™</div>
        <p style="font-size: 0.85rem; line-height: 1.6; color: rgba(255,255,255,0.7);">
          å¥½äººé˜µè¥æ¶ˆç­æ‰€æœ‰ç‹¼äººå³å¯è·èƒœã€‚ç‹¼äººé˜µè¥äººæ•° â‰¥ å¥½äººé˜µè¥æ—¶è·èƒœã€‚
        </p>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-gold" onclick="location.href='/ranking'">
          ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ
        </button>
        <button class="btn btn-secondary" onclick="location.href='/'">
          ğŸ  è¿”å›å¤§å…
        </button>
      </div>
    </div>
  </div>
  
  <!-- èƒœåˆ©å¼¹çª— -->
  <div class="winner-modal" id="winnerModal">
    <div class="winner-content">
      <h1 class="winner-title" id="winnerTitle">æ¸¸æˆç»“æŸ</h1>
      <p class="winner-text" id="winnerText">è·èƒœé˜µè¥</p>
      <div class="winner-stats">
        <div class="stat-item">
          <div class="stat-value" id="statDays">0</div>
          <div class="stat-label">æ¸¸æˆå¤©æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="statDeaths">0</div>
          <div class="stat-label">æ­»äº¡äººæ•°</div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="location.href='/'">è¿”å›å¤§å…</button>
    </div>
  </div>
  
  <script>
    // æ¸¸æˆçŠ¶æ€
    let gameState = null;
    let gameId = '';
    let autoPlayInterval = null;
    
    // è·å–æ¸¸æˆID
    gameId = window.location.pathname.split('/').pop();
    document.getElementById('gameId').textContent = gameId.slice(-8).toUpperCase();
    
    // åŠ è½½æ¸¸æˆçŠ¶æ€
    async function loadGame() {
      try {
        const res = await fetch(`/api/game/${gameId}`);
        gameState = await res.json();
        renderGame();
      } catch (e) {
        console.error('åŠ è½½æ¸¸æˆå¤±è´¥:', e);
      }
    }
    
    // æ¸²æŸ“æ¸¸æˆç•Œé¢
    function renderGame() {
      if (!gameState) return;
      
      // æ›´æ–°å¤©æ•°å’Œé˜¶æ®µ
      document.getElementById('dayNum').textContent = gameState.day || 0;
      
      const phaseNames = {
        'waiting': 'ç­‰å¾…å¼€å§‹',
        'night_wolf': 'ç‹¼äººè¡ŒåŠ¨',
        'night_seer': 'é¢„è¨€å®¶æŸ¥éªŒ',
        'night_witch': 'å¥³å·«è¡ŒåŠ¨',
        'dawn': 'å¤©äº®å…¬å‘Š',
        'day_speech': 'ç™½å¤©å‘è¨€',
        'vote': 'æŠ•ç¥¨',
        'hunter_shoot': 'çŒäººå¼€æª',
        'ended': 'æ¸¸æˆç»“æŸ'
      };
      
      const phase = gameState.phase || 'waiting';
      document.getElementById('phaseIndicator').textContent = phaseNames[phase] || phase;
      
      // æ›´æ–°æ˜¼å¤œæ˜¾ç¤º
      const dayIndicator = document.getElementById('dayIndicator');
      if (phase.includes('night')) {
        dayIndicator.className = 'day-indicator night';
        document.body.className = 'night-mode';
      } else {
        dayIndicator.className = 'day-indicator day';
        document.body.className = 'day-mode';
      }
      
      // æ›´æ–°å­˜æ´»äººæ•°
      const aliveCount = { wolf: 0, village: 0 };
      gameState.players?.forEach(p => {
        if (p.alive) {
          if (p.team === 'wolf') aliveCount.wolf++;
          else aliveCount.village++;
        }
      });
      document.getElementById('wolfCount').textContent = aliveCount.wolf;
      document.getElementById('goodCount').textContent = aliveCount.village;
      
      // æ›´æ–°ç©å®¶åˆ—è¡¨
      renderPlayers();
      
      // æ›´æ–°å¯¹è¯
      renderMessages();
      
      // æ›´æ–°é˜¶æ®µæ—¶é—´çº¿
      updatePhaseTimeline(phase);
      
      // æ£€æŸ¥èƒœåˆ©
      if (gameState.winner) {
        showWinner();
      }
    }
    
    // æ¸²æŸ“ç©å®¶åˆ—è¡¨
    function renderPlayers() {
      const playerList = document.getElementById('playerList');
      
      if (!gameState.players) {
        playerList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">ç­‰å¾…ç©å®¶...</p>';
        return;
      }
      
      playerList.innerHTML = gameState.players.map((p, i) => {
        const roleClass = p.role?.toLowerCase() || 'villager';
        const isCurrentSpeaker = gameState.phase === 'day_speech' && 
                                  gameState.currentSpeakerIndex === i;
        
        // åº§ä½å·æ˜¾ç¤º
        const seatNumber = p.seatNumber ? `${p.seatNumber}å·` : `${i + 1}å·`;
        
        // æ­»äº¡ä¿¡æ¯
        let deathInfo = '';
        if (!p.alive) {
          deathInfo = `<div style="font-size: 0.75rem; color: var(--wolf); margin-top: 4px;">
            ğŸ’€ ${p.deathReason || 'å·²æ­»äº¡'} ${p.deathDay ? `(ç¬¬${p.deathDay}å¤©)` : ''}
          </div>`;
        }
        
        return `
          <div class="player-card ${p.alive ? '' : 'dead'} ${isCurrentSpeaker ? 'current-speaker' : ''}" 
               onclick="showPlayerInfo('${p.userId}')">
            <div class="player-avatar ${roleClass}">
              ${p.seatNumber || i + 1}
            </div>
            <div class="player-info">
              <div class="player-name">
                <span style="background: rgba(255,215,0,0.2); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 6px;">
                  ${seatNumber}
                </span>
                ${p.name}
                ${p.isAi ? '<span class="player-badge badge-ai">AI</span>' : '<span class="player-badge badge-human">ç©å®¶</span>'}
              </div>
              <div class="player-role">
                ${p.roleName || p.role} Â· ${p.team === 'wolf' ? 'ğŸº ç‹¼äºº' : 'ğŸ§‘ å¥½äºº'}
              </div>
              ${deathInfo}
            </div>
            <div class="player-status ${p.alive ? '' : 'dead'}">
              ${p.alive ? 'âœ…' : 'ğŸ’€'}
            </div>
          </div>
        `;
      }).join('');
    }
    
    // æ¸²æŸ“æ¶ˆæ¯
    function renderMessages() {
      const chatMessages = document.getElementById('chatMessages');
      
      if (!gameState.messages || gameState.messages.length === 0) {
        return;
      }
      
      const roleIcons = { 'ç‹¼äºº': 'ğŸº', 'é¢„è¨€å®¶': 'ğŸ”®', 'å¥³å·«': 'ğŸ§ª', 'çŒäºº': 'ğŸ¯', 'å¹³æ°‘': 'ğŸ‘¥' };
      
      chatMessages.innerHTML = gameState.messages.map(msg => {
        // ç³»ç»Ÿæ¶ˆæ¯
        if (msg.speakerName === 'system') {
          let systemClass = 'system';
          let icon = 'ğŸ“¢';
          
          if (msg.messageType === 'death') {
            systemClass = 'system death';
            icon = 'ğŸ’€';
          } else if (msg.messageType === 'vote_result') {
            systemClass = 'system vote-result';
            icon = 'ğŸ—³ï¸';
          } else if (msg.messageType === 'vote_detail') {
            systemClass = 'system vote-detail';
            icon = 'ğŸ—³ï¸';
          } else if (msg.messageType === 'hunter_shoot') {
            systemClass = 'system hunter';
            icon = 'ğŸ”«';
          } else if (msg.messageType === 'vote_start') {
            systemClass = 'system vote-start';
            icon = 'ğŸ—³ï¸';
          }
          
          return `
            <div class="message ${systemClass}">
              <div class="message-content" style="max-width: 100%;">
                <div class="message-bubble" style="text-align: center;">
                  <span style="margin-right: 8px;">${icon}</span>${msg.message}
                </div>
              </div>
            </div>
          `;
        }
        
        // æ™®é€šå‘è¨€
        return `
          <div class="message">
            <div class="message-avatar">${roleIcons[msg.speakerRole] || 'ğŸ‘¤'}</div>
            <div class="message-content">
              <div class="message-header">
                <span class="message-name">${msg.speakerName}</span>
                <span style="background: rgba(255,215,0,0.2); padding: 1px 5px; border-radius: 4px; font-size: 0.7rem; margin-right: 6px;">
                  ${msg.turn ? `${msg.turn}å·` : ''}
                </span>
                <span class="message-role">${msg.speakerRole}</span>
              </div>
              <div class="message-bubble">${msg.message}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // æ›´æ–°é˜¶æ®µæ—¶é—´çº¿
    function updatePhaseTimeline(currentPhase) {
      const phases = ['waiting', 'night_wolf', 'night_seer', 'night_witch', 'dawn', 'day_speech', 'vote'];
      
      document.querySelectorAll('.phase-item').forEach(item => {
        const phase = item.dataset.phase;
        item.classList.remove('active', 'completed');
        
        if (phase === currentPhase) {
          item.classList.add('active');
        } else if (phases.indexOf(phase) < phases.indexOf(currentPhase)) {
          item.classList.add('completed');
        }
      });
    }
    
    // ä¸‹ä¸€æ­¥
    async function nextPhase() {
      const btn = document.getElementById('nextBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
      
      try {
        const res = await fetch(`/api/game/${gameId}/next`, {
          method: 'POST'
        });
        
        const data = await res.json();
        if (data.success) {
          gameState = data;
          renderGame();
        }
      } catch (e) {
        console.error('æ¨è¿›å¤±è´¥:', e);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'â­ï¸ ä¸‹ä¸€æ­¥';
      }
    }
    
    // è‡ªåŠ¨æ’­æ”¾
    async function autoPlay() {
      const btn = document.getElementById('autoBtn');
      
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
        btn.textContent = 'âš¡ è‡ªåŠ¨';
        btn.classList.remove('btn-gold');
      } else {
        btn.textContent = 'â¹ï¸ åœæ­¢';
        btn.classList.add('btn-gold');
        
        autoPlayInterval = setInterval(async () => {
          if (gameState?.winner) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null;
            btn.textContent = 'âš¡ è‡ªåŠ¨';
            return;
          }
          
          try {
            const res = await fetch(`/api/game/${gameId}/next`, {
              method: 'POST'
            });
            
            const data = await res.json();
            if (data.success) {
              gameState = data;
              renderGame();
            }
          } catch (e) {
            console.error('è‡ªåŠ¨æ¨è¿›å¤±è´¥:', e);
          }
        }, 3000);
      }
    }
    
    // æ˜¾ç¤ºèƒœåˆ©
    function showWinner() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
      }
      
      const modal = document.getElementById('winnerModal');
      const title = document.getElementById('winnerTitle');
      const text = document.getElementById('winnerText');
      
      if (gameState.winner === 'wolf') {
        title.textContent = 'ğŸº ç‹¼äººé˜µè¥è·èƒœï¼';
        title.className = 'winner-title wolf';
        text.textContent = 'æš—å½±åå™¬äº†å…‰æ˜...';
      } else {
        title.textContent = 'ğŸ‘¥ å¥½äººé˜µè¥è·èƒœï¼';
        title.className = 'winner-title village';
        text.textContent = 'å…‰æ˜æˆ˜èƒœäº†é»‘æš—ï¼';
      }
      
      document.getElementById('statDays').textContent = gameState.day || 0;
      document.getElementById('statDeaths').textContent = gameState.players?.filter(p => !p.alive).length || 0;
      
      modal.classList.add('active');
    }
    
    // å®šæœŸåˆ·æ–°
    function startPolling() {
      setInterval(() => {
        if (!gameState?.winner) {
          loadGame();
        }
      }, 5000);
    }
    
    // åˆå§‹åŒ–
    loadGame();
    startPolling();
  </script>
</body>
</html>
